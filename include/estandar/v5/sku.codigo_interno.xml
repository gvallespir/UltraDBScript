<?xml version="1.0" encoding="ISO-8859-1"?>
<DBSCRIPT desc="Actualización de reemplazos" author="" date="">

<!--Iteracion-->
<SQL id="actualiza etl_sku_codigo_interno" db="STOCKDOWN" desc="actualiza etl_sku_codigo_interno"><![CDATA[
update etl_sku_codigo_interno
set 
etl_sku_codigo_interno.codigo_sku_reemplazante_final = etl_sku_codigo_interno.codigo_sku_reemplazante
]]></SQL>

<!--Condición de ordenamiento de cadenas, en la implementación por defecto se usa la fecha de creación como criterio de selección-->
<PARAM id="ZORDCODREE" value=" (case when s.fecha_incorporacion is null then adddate(curdate(),INTERVAL -600 MONTH) else s.fecha_incorporacion end) " />

<!--El primer paso consiste en recorrer la cadena desde el codigo (reemplazante) menos relevante (mas antigüo) al mas relevante (mas nuevo)-->
<ITERATION id="Iteracion cadena de reemplazos" token="|">
<SOURCE>
<SQL id="Obtiene reemplazo ordenados 1" db="STOCKDOWN">
		SELECT
        z.codigo_sku,
		z.codigo_sku_reemplazante,
		z.codigo_sku_reemplazante_final
		FROM etl_sku_codigo_interno z
        LEFT JOIN sku s ON z.codigo_sku_reemplazante=s.codigo_sku
		ORDER BY
        %ZORDCODREE%
</SQL>
</SOURCE>
<PROCESS loglevel="0">
<SQL id="asignar codigo preferido 1 (|codigo_sku|,|codigo_sku_reemplazante|,|codigo_sku_reemplazante_final|)" db="STOCKDOWN">
		UPDATE `etl_sku_codigo_interno`
		SET codigo_sku_reemplazante_final='|codigo_sku_reemplazante_final|'
		WHERE codigo_sku_reemplazante_final='|codigo_sku|'
</SQL>
</PROCESS>
</ITERATION>

<!--El segundo paso consiste en identificar si los SKUs de la cadena tienen algún reemplazo (cabeza) más nuevo y homologarlo a toda la cadena-->
<ITERATION id="Asigna los mas importante en orden" token="|">
<SOURCE>
<SQL id="Obtiene reemplazo ordenados 2" db="STOCKDOWN">
	SELECT
	z.codigo_sku,z.codigo_sku_reemplazante,
	(
		SELECT z2.codigo_sku_reemplazante_final from
		etl_sku_codigo_interno z2
		LEFT JOIN sku s ON z2.codigo_sku_reemplazante_final=s.codigo_sku
		,etl_sku_codigo_interno z3
		WHERE z2.codigo_sku=z3.codigo_sku and
		z3.codigo_sku_reemplazante_final=z.codigo_sku_reemplazante_final
		ORDER BY %ZORDCODREE% DESC LIMIT 1
	) as codigo_sku_reemplazante_final
	FROM etl_sku_codigo_interno z
</SQL>
</SOURCE>
<PROCESS loglevel="0">
<SQL id="asignar codigo preferido 2 (|codigo_sku|,|codigo_sku_reemplazante|,|codigo_sku_reemplazante_final|)" db="STOCKDOWN">
		UPDATE etl_sku_codigo_interno
		SET codigo_sku_reemplazante_final='|codigo_sku_reemplazante_final|'
		WHERE codigo_sku='|codigo_sku|'
</SQL>
</PROCESS>
</ITERATION>

<!--El tercer paso consite en identificar si existe items su reemplazante a su vez tenga otro reemplazante mas nuevo -->
<ITERATION id="Revisa cadenas mixtas y asigna mas prioritario" token="|">
<SOURCE>
<SQL id="Obtiene reemplazo ordenados 3" db="STOCKDOWN">
	SELECT
	z.codigo_sku,z.codigo_sku_reemplazante,
	(
		SELECT z2.codigo_sku_reemplazante_final from
		etl_sku_codigo_interno z2
		LEFT JOIN sku s ON z2.codigo_sku_reemplazante_final=s.codigo_sku
		,etl_sku_codigo_interno z3
		WHERE
		z2.codigo_sku_reemplazante=z3.codigo_sku_reemplazante_final and
		z3.codigo_sku_reemplazante_final=z.codigo_sku_reemplazante_final
		ORDER BY %ZORDCODREE% DESC LIMIT 1
	) as codigo_sku_reemplazante_final
	FROM etl_sku_codigo_interno z
</SQL>
</SOURCE>
<PROCESS loglevel="0">
<SQL id="asignar codigo preferido 3 (|codigo_sku|,|codigo_sku_reemplazante|,|codigo_sku_reemplazante_final|)" db="STOCKDOWN">
		UPDATE etl_sku_codigo_interno
		SET codigo_sku_reemplazante_final='|codigo_sku_reemplazante_final|'
		WHERE codigo_sku='|codigo_sku|' and
		codigo_sku_reemplazante='|codigo_sku_reemplazante|'
</SQL>
</PROCESS>
</ITERATION>

<!--Reemplazados-->
<SQL db="STOCKDOWN" id="reemplazo inicialización" desc="reemplazo inicialización" ><![CDATA[
UPDATE sku

SET
 sku.codigo_interno=sku.codigo_sku
,sku.codigo_sku_reemplazante=null

]]></SQL>

<SQL db="STOCKDOWN" id="reemplazo" desc="reemplazo" ><![CDATA[
UPDATE sku, etl_sku_codigo_interno

SET
 sku.codigo_interno=etl_sku_codigo_interno.codigo_sku_reemplazante_final
,sku.codigo_sku_reemplazante=etl_sku_codigo_interno.codigo_sku_reemplazante_final

WHERE
sku.codigo_sku=etl_sku_codigo_interno.codigo_sku
]]></SQL>

<SQL db="STOCKDOWN" id="reemplazo fix" desc="reemplazo fix" ><![CDATA[

UPDATE
sku LEFT JOIN sku s2 ON sku.codigo_interno=s2.codigo_sku

SET
 sku.codigo_interno=sku.codigo_sku
,sku.codigo_sku_reemplazante=null

WHERE s2.codigo_sku is null

]]></SQL>

</DBSCRIPT>