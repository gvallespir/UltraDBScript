<?xml version="1.0" encoding="ISO-8859-1"?>
<DBSCRIPT desc="Actualización de DEMANDA" author="" date="">

<PARAM id="STRING_FECHA" value="" db="STOCKDOWN" sqlvalue="SELECT case when %UNIDAD_DEMANDA%=4 then '(dayofmonth(t.fecha)-1)' when %UNIDAD_DEMANDA%=2 then 'if(dayofweek(t.fecha)=1,6,dayofweek(t.fecha)-2)' else '(dayofmonth(t.fecha)-1)' end" />
<PARAM id="FECHA_AGRUPACION" value="date_add(t.fecha, INTERVAL -%STRING_FECHA% DAY)" />

<SQL db="STOCKDOWN" id="Actualiza DEMANDA " desc="Actualiza DEMANDA desde etl_demanda_dtl" ><![CDATA[
UPDATE demanda,
(
SELECT
t.codigo_sku,t.codigo_centro
,%FECHA_AGRUPACION% as fecha,
sum(t.cantidad) as cantidad,
sum(t.numero_lineas) as numero_lineas,
sum(t.monto) as monto_venta
FROM etl_demanda_dtl t
WHERE
t.fecha< %FECHA_DEMANDA_ACTUAL%
GROUP BY
t.codigo_sku,t.codigo_centro
,%FECHA_AGRUPACION%
) zz
SET demanda.cantidad=zz.cantidad
, demanda.z_cantidad=zz.numero_lineas
, demanda.numero_eventos=zz.numero_lineas
, demanda.numero_lineas=zz.numero_lineas
, demanda.monto_venta=zz.monto_venta
WHERE demanda.codigo_sku=zz.codigo_sku
AND demanda.codigo_centro=zz.codigo_centro
AND demanda.fecha=zz.fecha
]]></SQL>

<SQL db="STOCKDOWN" id="Inserta DEMANDA " desc="Inserta DEMANDA desde etl_demanda_dtl " ><![CDATA[
INSERT INTO demanda
(codigo_sku,codigo_centro,fecha,cantidad,z_cantidad,numero_eventos,numero_lineas,valido_pron,monto_venta)
SELECT zz.codigo_sku,zz.codigo_centro,zz.fecha,ifnull(zz.cantidad, 0),zz.numero_lineas,zz.numero_lineas,zz.numero_lineas,1 valido_pron,zz.monto_venta
FROM
(
SELECT
t.codigo_sku,t.codigo_centro
,%FECHA_AGRUPACION% as fecha,
ifnull(sum(t.cantidad), 0) as cantidad,
sum(t.numero_lineas) as numero_lineas,
sum(t.monto) as monto_venta
FROM etl_demanda_dtl t
WHERE
t.fecha< %FECHA_DEMANDA_ACTUAL%
GROUP BY
t.codigo_sku,t.codigo_centro
,%FECHA_AGRUPACION%
) zz LEFT JOIN
demanda d ON
d.codigo_sku=zz.codigo_sku AND d.codigo_centro=zz.codigo_centro AND d.fecha=zz.fecha
WHERE d.codigo_sku is null
]]></SQL>

</DBSCRIPT>