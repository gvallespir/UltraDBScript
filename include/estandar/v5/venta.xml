<?xml version="1.0" encoding="ISO-8859-1"?>
<DBSCRIPT desc="Actualización de VENTA" author="" date="">

<PARAM id="STRING_FECHA" value="" db="STOCKDOWN" sqlvalue="SELECT case when %UNIDAD_DEMANDA%=4 then '(dayofmonth(t.fecha)-1)' when %UNIDAD_DEMANDA%=2 then 'if(dayofweek(t.fecha)=1,6,dayofweek(t.fecha)-2)' else '(dayofmonth(t.fecha)-1)' end" />
<PARAM id="FECHA_AGRUPACION" value="date_add(t.fecha, INTERVAL -%STRING_FECHA% DAY)" />

<SQL db="STOCKDOWN" id="Actualiza VENTA " desc="Actualiza VENTA desde etl_venta_dtl" ><![CDATA[
UPDATE venta,
(
SELECT
t.codigo_sku,t.codigo_centro
,%FECHA_AGRUPACION% as fecha,
sum(t.cantidad) as cantidad,
sum(t.numero_lineas) as numero_lineas,
sum(t.monto) as monto_venta
FROM etl_venta_dtl t
WHERE
t.fecha< %FECHA_DEMANDA_ACTUAL%
GROUP BY
t.codigo_sku,t.codigo_centro
,%FECHA_AGRUPACION%
) zz
SET venta.cantidad=zz.cantidad
, venta.monto_venta=zz.monto_venta
, venta.monto=zz.monto_venta
WHERE venta.codigo_sku=zz.codigo_sku
AND venta.codigo_centro=zz.codigo_centro
AND venta.fecha=zz.fecha
]]></SQL>

<SQL db="STOCKDOWN" id="Inserta VENTA " desc="Inserta VENTA desde etl_venta_dtl " ><![CDATA[
INSERT INTO venta
(codigo_sku,codigo_centro,fecha,cantidad,monto_venta,monto)
SELECT zz.codigo_sku,zz.codigo_centro,zz.fecha,zz.cantidad,zz.monto_venta,zz.monto_venta
FROM
(
SELECT
t.codigo_sku,t.codigo_centro
,%FECHA_AGRUPACION% as fecha,
sum(t.cantidad) as cantidad,
sum(t.numero_lineas) as numero_lineas,
sum(t.monto) as monto_venta
FROM etl_venta_dtl t
WHERE
t.fecha< %FECHA_DEMANDA_ACTUAL%
GROUP BY
t.codigo_sku,t.codigo_centro
,%FECHA_AGRUPACION%
) zz LEFT JOIN
venta d ON
d.codigo_sku=zz.codigo_sku AND d.codigo_centro=zz.codigo_centro AND d.fecha=zz.fecha
WHERE d.codigo_sku is null
]]></SQL>

</DBSCRIPT>