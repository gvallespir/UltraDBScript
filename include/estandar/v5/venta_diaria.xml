<?xml version="1.0" encoding="ISO-8859-1"?>
<DBSCRIPT desc="Actualización de VENTA_DIARIA" author="" date="">

<SQL db="STOCKDOWN" id="Actualiza VENTA_DIARIA desde etl_venta_dtl" desc="Actualiza VENTA_DIARIA desde etl_venta_dtl" ><![CDATA[
UPDATE venta_diaria,
(
	SELECT
	t.codigo_sku,t.codigo_centro,t.fecha
	,sum(t.cantidad) as cantidad
	,sum(t.numero_lineas) as numero_lineas
	,sum(t.monto) as monto_venta
	FROM etl_venta_dtl t
	GROUP BY
	t.codigo_sku,t.codigo_centro,t.fecha
) zz
SET venta_diaria.cantidad=zz.cantidad
, venta_diaria.monto_venta=zz.monto_venta
, venta_diaria.monto=zz.monto_venta
WHERE venta_diaria.codigo_sku=zz.codigo_sku
AND venta_diaria.codigo_centro=zz.codigo_centro
AND venta_diaria.fecha=zz.fecha
]]></SQL>

<SQL db="STOCKDOWN" id="insert VENTA_DIARIA desde etl_venta_dtl" desc="Agrega VENTA_DIARIA desde etl_venta_dtl" ><![CDATA[
INSERT INTO venta_diaria
(codigo_sku,codigo_centro,fecha,cantidad,monto_venta,monto)
SELECT zz.codigo_sku,zz.codigo_centro,zz.fecha,zz.cantidad,zz.monto_venta,zz.monto_venta
FROM
(
	SELECT
	t.codigo_sku,t.codigo_centro,t.fecha
	,sum(t.cantidad) as cantidad
	,sum(t.numero_lineas) as numero_lineas
	,sum(t.monto) as monto_venta
	FROM etl_venta_dtl t
	GROUP BY
	t.codigo_sku,t.codigo_centro,t.fecha
) zz LEFT JOIN
venta_diaria d ON
d.codigo_sku=zz.codigo_sku AND d.codigo_centro=zz.codigo_centro AND d.fecha=zz.fecha
WHERE d.codigo_sku is null
]]></SQL>

</DBSCRIPT>